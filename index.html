<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>マーク設置用アプリ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: 'Helvetica Neue', sans-serif;
      background: #f0f4f8;
    }
    header {
      background: #003366;
      color: white;
      padding: 10px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    #map {
      height: 65vh;
      margin: 8px;
      border-radius: 10px;
    }
    .controls {
      padding: 10px;
    }
    .point-block {
      margin-bottom: 12px;
    }
    input[type="text"] {
      width: 100%;
      padding: 6px;
      font-size: 1em;
      margin-top: 4px;
    }
    button {
      padding: 6px 12px;
      margin-top: 6px;
      font-size: 0.9em;
      border: none;
      border-radius: 4px;
      background: #003366;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #005599;
    }
    .label {
      background: rgba(255, 255, 255, 0.8);
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 0.9em;
      pointer-events: none;
    }
    svg text {
      fill: #003366;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <h2>マーク設置用アプリ</h2>
    <div id="distance-info"></div>
    <div id="bearing-info"></div>
  </header>

  <div id="map"></div>

  <div class="controls">
    <div class="point-block">
      <label>上マーク（A）緯度, 経度</label>
      <input id="inputA" type="text" placeholder="例: 35.123456, 135.123456" />
      <button onclick="setPointFromInput(0)">登録</button>
    </div>
    <div class="point-block">
      <label>サイドマーク（B）緯度, 経度</label>
      <input id="inputB" type="text" placeholder="例: 35.123456, 135.123456" />
      <button onclick="setPointFromInput(1)">登録</button>
    </div>
    <div class="point-block">
      <label>下マーク（C）緯度, 経度</label>
      <input id="inputC" type="text" placeholder="例: 35.123456, 135.123456" />
      <button onclick="setPointFromInput(2)">登録</button>
    </div>
    <button onclick="resetAll()">全体リセット</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map("map").setView([35.0582072, 135.8801857], 16);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    const pointData = [null, null, null];
    const labels = ["上マーク", "サイドマーク", "下マーク"];
    const markers = [];
    const lines = [];
    const angleLabels = [];
    const nameLabels = [];

    function toRad(deg) {
      return (deg * Math.PI) / 180;
    }

    function toDeg(rad) {
      return (rad * 180) / Math.PI;
    }

    function haversine(p1, p2) {
      const R = 6371e3;
      const φ1 = toRad(p1.lat), φ2 = toRad(p2.lat);
      const Δφ = toRad(p2.lat - p1.lat);
      const Δλ = toRad(p2.lng - p1.lng);
      const a = Math.sin(Δφ / 2) ** 2 +
                Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function bearing(from, to) {
      const φ1 = toRad(from.lat);
      const φ2 = toRad(to.lat);
      const λ1 = toRad(from.lng);
      const λ2 = toRad(to.lng);
      const y = Math.sin(λ2 - λ1) * Math.cos(φ2);
      const x = Math.cos(φ1) * Math.sin(φ2) -
                Math.sin(φ1) * Math.cos(φ2) * Math.cos(λ2 - λ1);
      return (toDeg(Math.atan2(y, x)) + 360) % 360;
    }

    function computeAngle(a, b, c) {
      const ab = haversine(a, b);
      const ac = haversine(a, c);
      const bc = haversine(b, c);
      const angleA = Math.acos((ab**2 + ac**2 - bc**2)/(2*ab*ac));
      const angleB = Math.acos((ab**2 + bc**2 - ac**2)/(2*ab*bc));
      const angleC = Math.PI - angleA - angleB;
      return [toDeg(angleA), toDeg(angleB), toDeg(angleC)];
    }

    function updateMap() {
      markers.forEach(m => map.removeLayer(m));
      lines.forEach(l => map.removeLayer(l));
      angleLabels.forEach(l => map.removeLayer(l));
      nameLabels.forEach(l => map.removeLayer(l));
      markers.length = lines.length = angleLabels.length = nameLabels.length = 0;

      pointData.forEach((p, i) => {
        if (p) {
          const marker = L.circleMarker(p, {
            radius: 6,
            color: "#003366",
            fillColor: "#0055aa",
            fillOpacity: 1
          }).addTo(map);
          markers.push(marker);

          const offset = 0.0004;
          const label = L.divIcon({
            className: 'label',
            html: `${labels[i]}`,
            iconAnchor: [0, 0],
          });
          const labelMarker = L.marker([p.lat + offset, p.lng + offset], { icon: label }).addTo(map);
          nameLabels.push(labelMarker);
        }
      });

      if (pointData.every(p => p)) {
        const [a, b, c] = pointData;
        const segments = [[a,b], [b,c], [c,a]];
        segments.forEach(seg => {
          const line = L.polyline(seg, { color: "#003366", weight: 2 }).addTo(map);
          lines.push(line);
        });

        const angles = computeAngle(a, b, c);
        const anglePoints = [a, b, c];
        angles.forEach((angle, i) => {
          const p = anglePoints[i];
          const offset = 0.00025;
          const label = L.divIcon({
            className: 'label',
            html: `${angle.toFixed(1)}°`,
            iconAnchor: [0, 0],
          });
          const angleMarker = L.marker([p.lat - offset, p.lng - offset], { icon: label }).addTo(map);
          angleLabels.push(angleMarker);
        });

        const dist = haversine(c, a);
        const brng = bearing(c, a);
        document.getElementById("distance-info").textContent =
          `距離（下→上）: ${(dist / 1000).toFixed(2)} km`;
        document.getElementById("bearing-info").textContent =
          `地球方位角: ${brng.toFixed(2)}°`;
      } else {
        document.getElementById("distance-info").textContent = "";
        document.getElementById("bearing-info").textContent = "";
      }
    }

    function setPointFromInput(index) {
      const inputId = ["inputA", "inputB", "inputC"][index];
      const val = document.getElementById(inputId).value;
      const match = val.match(/([-+]?[0-9]*\.?[0-9]+)[,\s]+([-+]?[0-9]*\.?[0-9]+)/);
      if (match) {
        const lat = parseFloat(match[1]);
        const lng = parseFloat(match[2]);
        pointData[index] = { lat, lng };
        updateMap();
      } else {
        alert("正しい緯度経度を入力してください");
      }
    }

    function resetAll() {
      pointData.fill(null);
      updateMap();
      map.setView([35.0582072, 135.8801857], 16);
      document.getElementById("inputA").value = "";
      document.getElementById("inputB").value = "";
      document.getElementById("inputC").value = "";
    }

    updateMap(); // 初期化
  </script>
</body>
</html>
