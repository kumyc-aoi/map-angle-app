<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>マーク設置用アプリ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #f0f4f7;
    }
    header {
      background: #004466;
      color: white;
      padding: 1em;
      text-align: center;
      font-size: 1.2em;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    #status {
      margin-top: 0.5em;
      font-size: 0.9em;
      color: #e0f0ff;
    }
    #map {
      height: 70vh;
      margin: 0.5em;
      border: 2px solid #ccc;
      border-radius: 10px;
    }
    .control-panel {
      padding: 0.5em 1em;
      display: flex;
      flex-direction: column;
      gap: 0.5em;
    }
    input[type="text"] {
      width: 100%;
      padding: 0.4em;
      font-size: 1em;
    }
    button {
      padding: 0.6em;
      font-size: 1em;
      background: #0077aa;
      color: white;
      border: none;
      border-radius: 6px;
    }
    button:hover {
      background: #005577;
    }
    .label {
      font-size: 0.9em;
      font-weight: bold;
      text-align: center;
    }
    .angle-label {
      font-size: 0.8em;
      text-align: center;
      margin-top: 0.2em;
    }
  </style>
</head>
<body>
  <header>
    マーク設置用アプリ
    <div id="status"></div>
  </header>

  <div class="control-panel">
    <div>
      <label>上マーク緯度経度：</label>
      <input id="inputA" type="text" placeholder="34.7615747, 135.5314288">
      <button onclick="setPointFromInput('A')">上マークを登録</button>
    </div>
    <div>
      <label>下マーク緯度経度：</label>
      <input id="inputC" type="text" placeholder="34.7590016, 135.5329000">
      <button onclick="setPointFromInput('C')">下マークを登録</button>
    </div>
    <div>
      <button onclick="resetAll()">すべてリセット</button>
      <button onclick="addIdealSideMark()">理想サイドマークを表示</button>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map("map").setView([35.0582072, 135.8801857], 17);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap contributors",
    }).addTo(map);

    let markers = {};
    let lines = [];
    let labels = {};

    function resetAll() {
      Object.values(markers).forEach(m => map.removeLayer(m));
      Object.values(labels).forEach(l => map.removeLayer(l));
      lines.forEach(line => map.removeLayer(line));
      markers = {};
      labels = {};
      lines = [];
      map.setView([35.0582072, 135.8801857], 17);
      document.getElementById("status").innerHTML = "";
    }

    function parseLatLng(str) {
      const match = str.match(/(-?\d+(\.\d+)?),\s*(-?\d+(\.\d+)?)/);
      if (!match) return null;
      return [parseFloat(match[1]), parseFloat(match[3])];
    }

    function setPointFromInput(label) {
      const inputId = label === 'A' ? 'inputA' : 'inputC';
      const value = document.getElementById(inputId).value;
      const latlng = parseLatLng(value);
      if (!latlng) return alert("緯度経度を正しく入力してください");
      addMarker(label, latlng);
    }

    function addMarker(label, latlng) {
      if (markers[label]) map.removeLayer(markers[label]);
      if (labels[label]) map.removeLayer(labels[label]);

      const marker = L.circleMarker(latlng, {
        radius: 8,
        fillColor: label === 'B' ? "#00aa66" : "#0033cc",
        color: "#0033cc",
        weight: 2,
        opacity: 0.8,
        fillOpacity: 0.8
      }).addTo(map);

      const name = label === 'A' ? "上" : label === 'C' ? "下" : "理想B";
      const angle = labelAngles[label] ? `\n${labelAngles[label].toFixed(1)}°` : "";
      const labelText = `${name}${angle ? "\n" + angle : ""}`;

      const labelEl = L.marker(latlng, {
        icon: L.divIcon({
          className: 'custom-label',
          html: `<div class="label">${name}<div class="angle-label">${angle}</div></div>`,
          iconSize: [60, 30],
          iconAnchor: [30, -10]
        }),
        interactive: false
      }).addTo(map);

      markers[label] = marker;
      labels[label] = labelEl;

      if (markers.A && markers.C) {
        drawTriangle();
        updateStatus();
      }
    }

    function updateStatus() {
      const latlngA = markers.A.getLatLng();
      const latlngC = markers.C.getLatLng();
      const dist = haversine(latlngA, latlngC);
      const angle = bearing(latlngC, latlngA);
      document.getElementById("status").innerHTML =
        `距離: ${(dist / 1000).toFixed(2)} km<br>地球方位角: ${angle.toFixed(1)}°`;
    }

    function drawTriangle() {
      lines.forEach(line => map.removeLayer(line));
      lines = [];

      const A = markers.A.getLatLng();
      const C = markers.C.getLatLng();
      const B = markers.B ? markers.B.getLatLng() : null;

      const latlngs = [A, B, C].filter(p => p);
      for (let i = 0; i < latlngs.length; i++) {
        const from = latlngs[i];
        const to = latlngs[(i + 1) % latlngs.length];
        if (from && to) {
          const line = L.polyline([from, to], {
            color: "#0066cc",
            weight: 3,
            opacity: 0.5
          }).addTo(map);
          lines.push(line);
        }
      }

      // 内角ラベル
      if (A && B && C) {
        const a = angleBetween(B, A, C);
        const b = angleBetween(A, B, C);
        const c = angleBetween(A, C, B);
        labelAngles = { A: a, B: b, C: c };
        ["A", "B", "C"].forEach(l => {
          if (labels[l]) map.removeLayer(labels[l]);
          addMarker(l, markers[l].getLatLng()); // 更新
        });
      }
    }

    function addIdealSideMark() {
      if (!(markers.A && markers.C)) {
        alert("上マークと下マークを登録してください");
        return;
      }
      const A = markers.A.getLatLng();
