<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>マーク設置用アプリ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
    }
    #title {
      background: #0066cc;
      color: #fff;
      padding: 10px;
      text-align: center;
      font-size: 1.2rem;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
    }
    #map {
      height: 60vh;
      margin-top: 60px;
    }
    #inputs {
      padding: 10px;
    }
    .input-group {
      margin-bottom: 10px;
    }
    label {
      display: block;
      margin-bottom: 5px;
    }
    input[type="text"] {
      width: 80%;
      padding: 5px;
    }
    button {
      padding: 5px 10px;
      margin-left: 5px;
    }
    #resetAll {
      margin-top: 10px;
      padding: 8px 16px;
      background: red;
      color: white;
      border: none;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div id="title">マーク設置用アプリ</div>
  <div id="map"></div>
  <div id="inputs">
    <div class="input-group">
      <label>上マーク (緯度, 経度):</label>
      <input type="text" id="inputA" placeholder="例: 34.7615747, 135.5314288" />
      <button onclick="resetInput('A')">リセット</button>
    </div>
    <div class="input-group">
      <label>サイドマーク (緯度, 経度):</label>
      <input type="text" id="inputB" placeholder="例: 34.7615747, 135.5314288" />
      <button onclick="resetInput('B')">リセット</button>
    </div>
    <div class="input-group">
      <label>下マーク (緯度, 経度):</label>
      <input type="text" id="inputC" placeholder="例: 34.7615747, 135.5314288" />
      <button onclick="resetInput('C')">リセット</button>
    </div>
    <button id="resetAll" onclick="resetAll()">全体リセット</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map("map").setView([35.0582072, 135.8801857], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap contributors",
    }).addTo(map);

    const markers = {};
    const lines = [];
    const angleLabels = [];

    function toRad(deg) {
      return (deg * Math.PI) / 180;
    }

    function toDeg(rad) {
      return (rad * 180) / Math.PI;
    }

    function haversine(p1, p2) {
      const R = 6371e3;
      const φ1 = toRad(p1.lat), φ2 = toRad(p2.lat);
      const Δφ = toRad(p2.lat - p1.lat);
      const Δλ = toRad(p2.lng - p1.lng);
      const a =
        Math.sin(Δφ / 2) ** 2 +
        Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function bearing(from, to) {
      const φ1 = toRad(from.lat);
      const φ2 = toRad(to.lat);
      const λ1 = toRad(from.lng);
      const λ2 = toRad(to.lng);
      const y = Math.sin(λ2 - λ1) * Math.cos(φ2);
      const x =
        Math.cos(φ1) * Math.sin(φ2) -
        Math.sin(φ1) * Math.cos(φ2) * Math.cos(λ2 - λ1);
      return (toDeg(Math.atan2(y, x)) + 360) % 360;
    }

    function calculateAngle(a, b, c) {
      const ab = haversine(a, b);
      const bc = haversine(b, c);
      const ca = haversine(c, a);
      const angleA = Math.acos((ab ** 2 + ca ** 2 - bc ** 2) / (2 * ab * ca));
      const angleB = Math.acos((ab ** 2 + bc ** 2 - ca ** 2) / (2 * ab * bc));
      const angleC = Math.PI - angleA - angleB;
      return [toDeg(angleA), toDeg(angleB), toDeg(angleC)];
    }

    function updateMap() {
      // Remove existing markers, lines, and angle labels
      Object.values(markers).forEach(m => map.removeLayer(m));
      lines.forEach(l => map.removeLayer(l));
      angleLabels.forEach(l => map.removeLayer(l));
      lines.length = 0;
      angleLabels.length = 0;

      const inputs = {
        A: document.getElementById("inputA").value,
        B: document.getElementById("inputB").value,
        C: document.getElementById("inputC").value,
      };

      const points = {};
      for (let key in inputs) {
        const val = inputs[key];
        if (val) {
          const [lat, lng] = val.split(",").map(s => parseFloat(s.trim()));
          if (!isNaN(lat) && !isNaN(lng)) {
            points[key] = { lat, lng };
            markers[key] = L.marker([lat, lng])
              .addTo(map)
              .bindTooltip(
                key === "A" ? "上マーク" : key === "B" ? "サイドマーク" : "下マーク",
                { permanent: true, direction: "top" }
              )
              .openTooltip();
          }
        }
      }

      if (points.A && points.B && points.C) {
        // Draw lines
        lines.push(
          L.polyline([points.A, points.B], { color: "blue" }).addTo(map),
          L.polyline([points.B, points.C], { color: "blue" }).addTo(map),
          L.polyline([points.C, points.A], { color: "blue" }).addTo(map)
        );

        // Calculate angles
        const angles = calculateAngle(points.A, points.B, points.C);
        const anglePoints = [points.A, points.B, points.C];
        angles.forEach((angle, idx) => {
          angleLabels.push(
            L.marker(anglePoints[idx], {
              icon: L.divIcon({
                className: "angle-label",
                html: angle.toFixed(2) + "°",
              }),
            }).addTo(map)
          );
        });

        // Calculate distance and bearing
        const distance = haversine(points.C, points.A) / 1000;
        const angle = bearing(points.C, points.A);

        document.getElementById("title").innerText =
          `マーク設置用アプリ | 距離: ${distance.toFixed(2)} km | 方位角: ${angle.toFixed(2)}°`;
      }
    }

    function resetInput(key) {
      document.getElementById("input" + key).value = "";
      updateMap();
    }

    function resetAll() {
      document.getElementById("inputA").value = "";
      document.getElementById("inputB").value = "";
      document.getElementById("inputC").value = "";
      updateMap();
      map.setView([35.0582072, 135.8801857], 13);
      document.getElementById("title").innerText = "マーク設置用アプリ";
    }

    document.getElementById("inputA").addEventListener("change", updateMap);
    document.getElementById("inputB").addEventListener("change", updateMap);
    document.getElementById("inputC").addEventListener("change", updateMap);
  </script>
</body>
</html>
