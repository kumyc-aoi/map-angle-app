<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ä¸‰ç‚¹è§’åº¦æ¸¬å®šã‚¢ãƒ—ãƒª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    #map { height: 500px; width: 100%; margin-bottom: 1em; }
    .controls { margin-bottom: 10px; }
    .angle-label {
      background-color: white;
      padding: 2px 4px;
      border-radius: 3px;
      font-size: 12px;
    }
    #results {
      font-size: 18px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>ä¸‰ç‚¹è§’åº¦æ¸¬å®šã‚¢ãƒ—ãƒª</h2>

  <div class="controls">
    <h3>ä¸Šãƒãƒ¼ã‚¯ï¼ˆAï¼‰</h3>
    <button onclick="useCurrentLocation('A')">ğŸ“ç¾åœ¨åœ°ã§ç™»éŒ²</button><br>
    ç·¯åº¦: <input type="number" id="lat-A" step="any">
    çµŒåº¦: <input type="number" id="lng-A" step="any">
    <button onclick="useManualInput('A')">æ‰‹å‹•ã§ç™»éŒ²</button>
  </div>

  <div class="controls">
    <h3>ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚¯ï¼ˆBï¼‰</h3>
    <button onclick="useCurrentLocation('B')">ğŸ“ç¾åœ¨åœ°ã§ç™»éŒ²</button><br>
    ç·¯åº¦: <input type="number" id="lat-B" step="any">
    çµŒåº¦: <input type="number" id="lng-B" step="any">
    <button onclick="useManualInput('B')">æ‰‹å‹•ã§ç™»éŒ²</button>
  </div>

  <div class="controls">
    <h3>ä¸‹ãƒãƒ¼ã‚¯ï¼ˆCï¼‰</h3>
    <button onclick="useCurrentLocation('C')">ğŸ“ç¾åœ¨åœ°ã§ç™»éŒ²</button><br>
    ç·¯åº¦: <input type="number" id="lat-C" step="any">
    çµŒåº¦: <input type="number" id="lng-C" step="any">
    <button onclick="useManualInput('C')">æ‰‹å‹•ã§ç™»éŒ²</button>
  </div>

  <div id="map"></div>
  <div id="results"></div>

  <script>
    let map;
    const markers = {};
    const labels = {};
    let triangleLine;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 35.681, lng: 139.767 },
        zoom: 10,
      });
    }

    function useCurrentLocation(mark) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          setMarker(mark, lat, lng);
        }, () => alert("ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"));
      } else {
        alert("ã“ã®ç«¯æœ«ã§ã¯ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“");
      }
    }

    function useManualInput(mark) {
      const lat = parseFloat(document.getElementById(`lat-${mark}`).value);
      const lng = parseFloat(document.getElementById(`lng-${mark}`).value);
      if (!isNaN(lat) && !isNaN(lng)) {
        setMarker(mark, lat, lng);
      } else {
        alert("ç·¯åº¦ãƒ»çµŒåº¦ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„");
      }
    }

    function setMarker(mark, lat, lng) {
      if (markers[mark]) {
        markers[mark].setMap(null);
      }
      markers[mark] = new google.maps.Marker({
        position: { lat, lng },
        map,
        label: mark,
      });
      map.panTo({ lat, lng });
      updateTriangleAndAngles();
    }

    function updateTriangleAndAngles() {
      const A = markers['A']?.getPosition();
      const B = markers['B']?.getPosition();
      const C = markers['C']?.getPosition();
      if (!(A && B && C)) return;

      // æ¸…æƒ
      for (const key in labels) {
        labels[key].setMap(null);
      }
      labels.length = 0;
      if (triangleLine) triangleLine.setMap(null);

      const a = haversineDistance(B, C);
      const b = haversineDistance(A, C);
      const c = haversineDistance(A, B);

      const angleA = getAngle(b, c, a);
      const angleB = getAngle(a, c, b);
      const angleC = 180 - angleA - angleB;

      labels['A'] = addLabel(A, `${angleA.toFixed(1)}Â°`);
      labels['B'] = addLabel(B, `${angleB.toFixed(1)}Â°`);
      labels['C'] = addLabel(C, `${angleC.toFixed(1)}Â°`);

      triangleLine = new google.maps.Polyline({
        path: [A, B, C, A],
        geodesic: true,
        strokeColor: "#00BFFF",
        strokeOpacity: 0.8,
        strokeWeight: 2,
        map
      });

      const acDist = haversineDistance(A, C);
      const bearing = computeBearing(A, C);

      document.getElementById("results").innerHTML =
        `<strong>Aï¼ˆä¸Šãƒãƒ¼ã‚¯ï¼‰â†”Cï¼ˆä¸‹ãƒãƒ¼ã‚¯ï¼‰</strong><br>
        è·é›¢: ${acDist.toFixed(1)} m<br>
        æ–¹ä½è§’: ${bearing.toFixed(1)}Â°`;
    }

    function haversineDistance(pos1, pos2) {
      const R = 6371000;
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(pos2.lat() - pos1.lat());
      const dLng = toRad(pos2.lng() - pos1.lng());
      const lat1 = toRad(pos1.lat());
      const lat2 = toRad(pos2.lat());

      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLng / 2) ** 2;
      return 2 * R * Math.asin(Math.sqrt(a));
    }

    function computeBearing(from, to) {
      const toRad = deg => deg * Math.PI / 180;
      const toDeg = rad => rad * 180 / Math.PI;
      const lat1 = toRad(from.lat());
      const lat2 = toRad(to.lat());
      const dLng = toRad(to.lng() - from.lng());
      const y = Math.sin(dLng) * Math.cos(lat2);
      const x = Math.cos(lat1) * Math.sin(lat2) -
                Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLng);
      return (toDeg(Math.atan2(y, x)) + 360) % 360;
    }

    function getAngle(sideA, sideB, sideC) {
      // cos(âˆ C) = (aÂ² + bÂ² - cÂ²) / (2ab)
      return Math.acos((sideA ** 2 + sideB ** 2 - sideC ** 2) / (2 * sideA * sideB)) * 180 / Math.PI;
    }

    function addLabel(position, text) {
      return new google.maps.InfoWindow({
        content: `<div class="angle-label">${text}</div>`,
        position,
        pixelOffset: new google.maps.Size(15, -30),
      }).open(map);
    }
  </script>

  <script async
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap">
  </script>
</body>
</html>
